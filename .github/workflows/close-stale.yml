---
name: Close stale issues and PRs

# This workflow uses actions that are not certified by GitHub.
# They are provided by a third-party and are governed by
# separate terms of service, privacy policy, and support
# documentation.

# GitHub Actions Documentation
# https://docs.github.com/en/github-ae@latest/actions

# Reusing workflows
# https://docs.github.com/en/actions/using-workflows/reusing-workflows

on:
  # Run daily at 6:30 PM UTC
  schedule:
    - cron: '30 18 * * *'
  # on button click
  workflow_dispatch:
  # or allow this workflow to be called by other workflows
  workflow_call:
    inputs:
      stale_issue_label:
        description: 'Label to mark issues and PRs as stale'
        required: false
        type: string
        default: 'stale'
      stale_pr_label:
        description: 'Label to mark PRs as stale'
        required: false
        type: string
        default: 'stale'
      days_before_stale:
        description: 'Days before issues become stale'
        required: false
        type: number
        default: 90
      days_before_pr_stale:
        description: 'Days before PRs become stale'
        required: false
        type: number
        default: 45
      days_before_close:
        description: 'Days before stale issues are closed'
        required: false
        type: number
        default: 7
      days_before_pr_close:
        description: 'Days before PRs are closed (-1 to never close)'
        required: false
        type: number
        default: -1

env:
  DEFAULT_STALE_ISSUE_LABEL: 'stale'
  DEFAULT_STALE_PR_LABEL: 'stale'
  DEFAULT_DAYS_BEFORE_STALE: 90
  DEFAULT_DAYS_BEFORE_PR_STALE: 45
  DEFAULT_DAYS_BEFORE_CLOSE: 7
  DEFAULT_DAYS_BEFORE_PR_CLOSE: -1

  ISSUE_WARN_MESSAGE: >
    This issue is stale because it has been open
    ${{ inputs.days_before_stale || env.DEFAULT_DAYS_BEFORE_STALE }} days with
    no activity. Remove stale label or comment or this will be closed in
    ${{ inputs.days_before_close || env.DEFAULT_DAYS_BEFORE_CLOSE }} days.

  PR_WARN_MESSAGE: >
    This PR is stale because it has been open
    ${{ inputs.days_before_pr_stale || env.DEFAULT_DAYS_BEFORE_PR_STALE }} days
    with no activity. Remove stale label or comment or this will be closed in
    ${{ inputs.days_before_pr_close || env.DEFAULT_DAYS_BEFORE_PR_CLOSE }} days.

  ISSUE_CLOSE_MESSAGE: >
    This issue was closed because it has been stalled for
    ${{ inputs.days_before_close || env.DEFAULT_DAYS_BEFORE_CLOSE }} days
    with no activity. Feel free to reopen if this issue is still relevant, or
    to ping the collaborator who labelled it stalled if you have any questions.

  PR_CLOSE_MESSAGE: >
    This PR was closed because it has been stalled for
    ${{ inputs.days_before_pr_close || env.DEFAULT_DAYS_BEFORE_PR_CLOSE }} days
    with no activity. Feel free to reopen if this PR is still relevant, or to
    ping the collaborator who labelled it stalled if you have any questions.

jobs:
  stale:
    runs-on: ubuntu-latest
    permissions:
      # https://github.com/actions/stale#recommended-permissions
      issues: write
      pull-requests: write

    steps:
      # Close Stale Issues and PRs
      # https://github.com/actions/stale
      - uses: actions/stale@v10
        with:
          # Run the stale workflow as dry-run (no actions will be taken)
          # debug-only: true
          stale-issue-label: ${{ inputs.stale_issue_label || env.DEFAULT_STALE_ISSUE_LABEL }}
          stale-issue-message: ${{ env.ISSUE_WARN_MESSAGE }}
          close-issue-message: ${{ env.ISSUE_CLOSE_MESSAGE }}
          stale-pr-label: ${{ inputs.stale_pr_label || env.DEFAULT_STALE_PR_LABEL }}
          stale-pr-message: ${{ env.PR_WARN_MESSAGE }}
          close-pr-message: ${{ env.PR_CLOSE_MESSAGE }}
          days-before-stale: ${{ inputs.days_before_stale || env.DEFAULT_DAYS_BEFORE_STALE }}
          days-before-pr-stale: ${{ inputs.days_before_pr_stale || env.DEFAULT_DAYS_BEFORE_PR_STALE }}
          days-before-close: ${{ inputs.days_before_close || env.DEFAULT_DAYS_BEFORE_CLOSE }}
          days-before-pr-close: ${{ inputs.days_before_pr_close || env.DEFAULT_DAYS_BEFORE_PR_CLOSE }}
